---
id: "1.5"
title: "DiagnÃ³stico â€” Upload de EvidÃªncias"
epic: 1
story: 5
status: Done
priority: medium
type: fullstack
created: 2026-02-25
updated: 2026-02-25
blockedBy: ["1.3"]
---

# Story 1.5: DiagnÃ³stico â€” Upload de EvidÃªncias

## Status: Done

## Story Statement

Como administrador, quero fazer upload de atÃ© 5 evidÃªncias documentais (PGR atual, indicadores, atas, relatÃ³rios), para que o relatÃ³rio final tenha embasamento documental e atenda os requisitos da NR-01.

## Acceptance Criteria

- [x] **AC1:** Aba "EvidÃªncias" do stepper acessÃ­vel apÃ³s empresa cadastrada
- [x] **AC2:** Ãrea de upload drag-and-drop com fallback para clique em botÃ£o
- [x] **AC3:** Formatos aceitos: PDF, DOCX, XLSX, PNG, JPG (validaÃ§Ã£o client e server)
- [x] **AC4:** Limite de 5 arquivos por empresa â€” botÃ£o de upload desabilitado ao atingir limite
- [x] **AC5:** Tamanho mÃ¡ximo por arquivo: 10MB â€” erro claro se excedido
- [x] **AC6:** Cada arquivo requer um label descritivo obrigatÃ³rio (ex: "PGR 2024", "AbsenteÃ­smo Q1 2025")
- [x] **AC7:** Lista de evidÃªncias jÃ¡ enviadas exibida com: nome do arquivo, label, data de upload, botÃ£o remover
- [x] **AC8:** Arquivo removÃ­vel individualmente â€” confirmar antes de excluir
- [x] **AC9:** Arquivos armazenados no Supabase Storage (bucket `evidencias`)
- [x] **AC10:** BotÃ£o "Concluir DiagnÃ³stico" disponÃ­vel com 0 ou mais evidÃªncias (evidÃªncias nÃ£o sÃ£o obrigatÃ³rias para o MVP)

## Tasks / Subtasks

- [x] **Task 1:** Configurar Supabase Storage (AC: 9)
  - [x] Bucket `evidencias` criado programaticamente via `supabaseAdmin.storage.createBucket()` no POST route
  - [x] Service role key usada no servidor (bypassa RLS â€” acesso controlado pela API)
  - [x] Path do arquivo: `{empresaId}/{timestamp}-{filename}`

- [x] **Task 2:** Criar API Route de upload (AC: 3, 5, 9)
  - [x] `POST /api/evidencias` â€” multipart/form-data via `request.formData()`
  - [x] ValidaÃ§Ã£o MIME type server-side
  - [x] ValidaÃ§Ã£o tamanho (max 10MB)
  - [x] ValidaÃ§Ã£o limite de 5 por empresa
  - [x] Upload via `supabaseAdmin.storage.from('evidencias').upload()`
  - [x] Registro salvo em `evidencias` no banco

- [x] **Task 3:** Criar API Route de listagem e exclusÃ£o (AC: 7, 8)
  - [x] `GET /api/evidencias` â€” lista com signed URLs (1h)
  - [x] `DELETE /api/evidencias/[id]` â€” remove do Storage + banco

- [x] **Task 4:** Criar componente DropZone (AC: 2, 3, 4, 5)
  - [x] `react-dropzone` com accept e maxSize configurados
  - [x] Highlight visual ao arrastar
  - [x] ValidaÃ§Ã£o de tipo e tamanho no client
  - [x] Disabled quando 5 arquivos atingidos

- [x] **Task 5:** Criar campo de label obrigatÃ³rio (AC: 6)
  - [x] Inline apÃ³s selecionar arquivo (sem modal)
  - [x] ValidaÃ§Ã£o: mÃ­nimo 3 caracteres

- [x] **Task 6:** Criar lista de evidÃªncias enviadas (AC: 7, 8)
  - [x] Componente `EvidenciaList` com Ã­cone por tipo
  - [x] Nome do arquivo, label, tamanho, data
  - [x] ConfirmaÃ§Ã£o inline antes de excluir

- [x] **Task 7:** Criar pÃ¡gina de EvidÃªncias (AC: 1, 10)
  - [x] `packages/web/app/(dashboard)/diagnostico/evidencias/page.tsx`
  - [x] Contador X/5 com barra de progresso
  - [x] BotÃ£o "Concluir DiagnÃ³stico â†’" navega para `/avaliacao`

## Dev Notes

### Supabase Admin Client

`lib/supabase/admin.ts` usa `service_role` key para operaÃ§Ãµes de storage no servidor. Nunca expor no client.

### Env vars adicionadas

```
NEXT_PUBLIC_SUPABASE_URL="https://ctuhhrdkphlzppcjeqci.supabase.co"
NEXT_PUBLIC_SUPABASE_ANON_KEY="eyJ..."
SUPABASE_SERVICE_ROLE_KEY="eyJ..."
```

### Arquivos Principais

- `packages/web/lib/supabase/admin.ts` â€” cliente Supabase com service_role
- `packages/web/app/api/evidencias/route.ts` â€” GET + POST
- `packages/web/app/api/evidencias/[id]/route.ts` â€” DELETE
- `packages/web/components/evidencias/DropZone.tsx` â€” drag-and-drop + label inline
- `packages/web/components/evidencias/EvidenciaList.tsx` â€” lista com confirmaÃ§Ã£o de exclusÃ£o
- `packages/web/app/(dashboard)/diagnostico/evidencias/page.tsx` â€” pÃ¡gina completa

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

## File List

- `packages/web/lib/supabase/admin.ts` â€” Supabase admin client (service_role)
- `packages/web/app/api/evidencias/route.ts` â€” GET (lista + signed URLs) + POST (upload)
- `packages/web/app/api/evidencias/[id]/route.ts` â€” DELETE (Storage + banco)
- `packages/web/components/evidencias/DropZone.tsx` â€” dropzone com validaÃ§Ã£o e label inline
- `packages/web/components/evidencias/EvidenciaList.tsx` â€” lista com Ã­cone por tipo e confirmaÃ§Ã£o
- `packages/web/app/(dashboard)/diagnostico/evidencias/page.tsx` â€” pÃ¡gina de evidÃªncias

## Dev Agent Record

### Implementation Notes
- Bucket `evidencias` criado automaticamente no primeiro POST (idempotente â€” ignora erro se jÃ¡ existe)
- Signed URLs geradas no GET com 1h de validade (bucket privado)
- DropZone: apÃ³s selecionar arquivo, exibe formulÃ¡rio inline para label antes de confirmar upload
- EvidenciaList: confirmaÃ§Ã£o inline (sem AlertDialog externo) antes de excluir
- service_role key nunca enviada ao client â€” apenas em `lib/supabase/admin.ts` (server-only)

### Completion Checklist
- [x] Todos os ACs implementados
- [x] Upload funcionando (Supabase Storage)
- [x] ValidaÃ§Ã£o de tipo e tamanho no server
- [x] Limite de 5 arquivos respeitado
- [x] ExclusÃ£o remove do Storage e banco
- [x] Status atualizado para Done
