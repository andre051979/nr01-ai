---
id: "1.5"
title: "Diagn√≥stico ‚Äî Upload de Evid√™ncias"
epic: 1
story: 5
status: Draft
priority: medium
type: fullstack
created: 2026-02-25
updated: 2026-02-25
blockedBy: ["1.3"]
---

# Story 1.5: Diagn√≥stico ‚Äî Upload de Evid√™ncias

## Status: Draft

## Story Statement

Como administrador, quero fazer upload de at√© 5 evid√™ncias documentais (PGR atual, indicadores, atas, relat√≥rios), para que o relat√≥rio final tenha embasamento documental e atenda os requisitos da NR-01.

## Acceptance Criteria

- [ ] **AC1:** Aba "Evid√™ncias" do stepper acess√≠vel ap√≥s empresa cadastrada
- [ ] **AC2:** √Årea de upload drag-and-drop com fallback para clique em bot√£o
- [ ] **AC3:** Formatos aceitos: PDF, DOCX, XLSX, PNG, JPG (valida√ß√£o client e server)
- [ ] **AC4:** Limite de 5 arquivos por empresa ‚Äî bot√£o de upload desabilitado ao atingir limite
- [ ] **AC5:** Tamanho m√°ximo por arquivo: 10MB ‚Äî erro claro se excedido
- [ ] **AC6:** Cada arquivo requer um label descritivo obrigat√≥rio (ex: "PGR 2024", "Absente√≠smo Q1 2025")
- [ ] **AC7:** Lista de evid√™ncias j√° enviadas exibida com: nome do arquivo, label, data de upload, bot√£o remover
- [ ] **AC8:** Arquivo remov√≠vel individualmente ‚Äî confirmar antes de excluir
- [ ] **AC9:** Arquivos armazenados no Supabase Storage (bucket `evidencias`)
- [ ] **AC10:** Bot√£o "Concluir Diagn√≥stico" dispon√≠vel com 0 ou mais evid√™ncias (evid√™ncias n√£o s√£o obrigat√≥rias para o MVP)

## Tasks / Subtasks

- [ ] **Task 1:** Configurar Supabase Storage (AC: 9)
  - [ ] Criar bucket `evidencias` no Supabase Storage (privado)
  - [ ] Configurar RLS: apenas usu√°rios autenticados podem ler/escrever da pr√≥pria empresa
  - [ ] Path do arquivo: `{empresaId}/{timestamp}-{filename}`

- [ ] **Task 2:** Criar API Route de upload (AC: 3, 5, 9)
  - [ ] `POST /api/evidencias` ‚Äî multipart/form-data
  - [ ] Validar tipo MIME server-side (n√£o apenas extens√£o)
  - [ ] Validar tamanho (max 10MB)
  - [ ] Validar limite de 5 por empresa
  - [ ] Upload para Supabase Storage via `supabase.storage.from('evidencias').upload()`
  - [ ] Salvar registro em `evidencias` no banco com URL p√∫blica/assinada

- [ ] **Task 3:** Criar API Route de listagem e exclus√£o (AC: 7, 8)
  - [ ] `GET /api/evidencias` ‚Äî lista evid√™ncias da empresa logada
  - [ ] `DELETE /api/evidencias/:id` ‚Äî remove do Storage + banco em transa√ß√£o

- [ ] **Task 4:** Criar componente DropZone (AC: 2, 3, 4, 5)
  - [ ] Instalar `react-dropzone`
  - [ ] √Årea visual de drag-and-drop com √≠cone e instru√ß√µes
  - [ ] Highlight ao arrastar arquivo sobre a √°rea
  - [ ] Valida√ß√£o de tipo e tamanho antes do upload
  - [ ] Preview do nome do arquivo antes de confirmar
  - [ ] Disabled quando 5 arquivos j√° enviados

- [ ] **Task 5:** Criar campo de label obrigat√≥rio (AC: 6)
  - [ ] Modal ou inline: ap√≥s selecionar arquivo, solicitar label
  - [ ] Valida√ß√£o: label obrigat√≥rio, m√≠nimo 3 caracteres
  - [ ] Placeholder com exemplos: "PGR 2024", "Relat√≥rio de Absente√≠smo"

- [ ] **Task 6:** Criar lista de evid√™ncias enviadas (AC: 7, 8)
  - [ ] Componente `EvidenciaList`
  - [ ] Colunas: Label, Tipo, Tamanho, Data de Upload, A√ß√µes
  - [ ] Bot√£o remover com `AlertDialog` de confirma√ß√£o
  - [ ] √çcone por tipo de arquivo (PDF, Excel, Word, imagem)

- [ ] **Task 7:** Criar p√°gina de Evid√™ncias (AC: 1, 10)
  - [ ] `packages/web/app/(dashboard)/diagnostico/evidencias/page.tsx`
  - [ ] Contador: "X/5 evid√™ncias enviadas"
  - [ ] Bot√£o "Concluir Diagn√≥stico" ‚Üí navegar para `/avaliacao`

## Dev Notes

### Depend√™ncias

```bash
npm install react-dropzone
```

### Valida√ß√£o de Tipo MIME (server-side)

```typescript
const ALLOWED_TYPES = [
  'application/pdf',
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
  'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
  'image/png',
  'image/jpeg',
];

const ALLOWED_EXTENSIONS = ['.pdf', '.docx', '.xlsx', '.png', '.jpg', '.jpeg'];
```

### Upload para Supabase Storage

```typescript
const filePath = `${empresaId}/${Date.now()}-${file.name}`;
const { data, error } = await supabase.storage
  .from('evidencias')
  .upload(filePath, fileBuffer, {
    contentType: file.type,
    upsert: false,
  });
```

### Gera√ß√£o de URL Assinada (acesso privado)

```typescript
const { data: signedUrl } = await supabase.storage
  .from('evidencias')
  .createSignedUrl(filePath, 3600); // 1 hora de validade
```

### Arquivos Principais

- `packages/web/app/(dashboard)/diagnostico/evidencias/page.tsx`
- `packages/web/components/evidencias/DropZone.tsx`
- `packages/web/components/evidencias/EvidenciaList.tsx`
- `packages/web/app/api/evidencias/route.ts`
- `packages/web/app/api/evidencias/[id]/route.ts`

## ü§ñ CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

## File List

_A ser preenchido durante implementa√ß√£o_

## Dev Agent Record

### Implementation Notes
_A ser preenchido pelo @dev_

### Completion Checklist
- [ ] Todos os ACs implementados
- [ ] Upload funcionando (Supabase Storage)
- [ ] Valida√ß√£o de tipo e tamanho no server
- [ ] Limite de 5 arquivos respeitado
- [ ] Exclus√£o remove do Storage e banco
- [ ] Status atualizado para Done
