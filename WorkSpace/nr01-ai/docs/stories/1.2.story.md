---
id: "1.2"
title: "AutenticaÃ§Ã£o e Login do Administrador"
epic: 1
story: 2
status: Draft
priority: high
type: security
created: 2026-02-25
updated: 2026-02-25
blockedBy: ["1.1"]
---

# Story 1.2: AutenticaÃ§Ã£o e Login do Administrador

## Status: Done

## Story Statement

Como administrador do sistema, quero fazer login com email e senha, para que eu possa acessar com seguranÃ§a o painel de gestÃ£o de riscos psicossociais da empresa.

## Acceptance Criteria

- [ ] **AC1:** PÃ¡gina de login em `/login` com campos de email e senha, botÃ£o "Entrar" e validaÃ§Ã£o de campos obrigatÃ³rios
- [ ] **AC2:** AutenticaÃ§Ã£o via JWT â€” login bem-sucedido gera token armazenado em cookie httpOnly
- [ ] **AC3:** Rota `/` (dashboard) protegida â€” redireciona para `/login` se nÃ£o autenticado
- [ ] **AC4:** Senha armazenada com bcrypt (salt rounds â‰¥ 12) â€” nunca em texto puro
- [ ] **AC5:** Mensagem de erro genÃ©rica em caso de credenciais invÃ¡lidas ("Email ou senha incorretos") â€” sem vazamento de qual campo estÃ¡ errado
- [ ] **AC6:** BotÃ£o "Entrar" mostra estado de loading durante autenticaÃ§Ã£o
- [ ] **AC7:** ApÃ³s login bem-sucedido, redireciona para `/` (dashboard)
- [ ] **AC8:** Funcionalidade de logout disponÃ­vel no layout do dashboard â€” limpa cookie e redireciona para `/login`
- [ ] **AC9:** Seed inicial cria usuÃ¡rio admin padrÃ£o: `admin@nr01.com` / `admin123` (alterÃ¡vel via env)

## Tasks / Subtasks

- [x] **Task 1:** Criar API Route de autenticaÃ§Ã£o (AC: 2, 4, 5)
  - [x] Criar `packages/web/app/api/auth/login/route.ts` â€” POST
  - [x] Validar body com Zod: `{ email: string, password: string }`
  - [x] Buscar usuÃ¡rio no banco via Prisma por email
  - [x] Comparar senha com `bcrypt.compare()`
  - [x] Gerar JWT com `jose` library (payload: `{ userId, empresaId, role }`, exp: 8h)
  - [x] Setar cookie `auth-token` httpOnly, secure, sameSite=lax
  - [x] Retornar 401 com mensagem genÃ©rica em caso de erro

- [x] **Task 2:** Criar API Route de logout (AC: 8)
  - [x] Criar `packages/web/app/api/auth/logout/route.ts` â€” POST
  - [x] Limpar cookie `auth-token`
  - [x] Retornar redirect para `/login`

- [x] **Task 3:** Criar middleware de proteÃ§Ã£o de rotas (AC: 3)
  - [x] Criar `packages/web/middleware.ts`
  - [x] Verificar cookie `auth-token` em rotas `/(dashboard)/*`
  - [x] Redirecionar para `/login` se token invÃ¡lido/ausente
  - [x] Usar `jose` para verificaÃ§Ã£o do JWT no edge runtime

- [x] **Task 4:** Criar pÃ¡gina de Login UI (AC: 1, 6, 7)
  - [x] Criar `packages/web/app/(auth)/login/page.tsx`
  - [x] Form com campos: email (type=email), senha (type=password)
  - [x] ValidaÃ§Ã£o client-side com react-hook-form + Zod
  - [x] Estado de loading no botÃ£o durante fetch
  - [x] Exibir mensagem de erro da API
  - [x] Layout centralizado, responsivo, com logo/nome do sistema

- [x] **Task 5:** Criar botÃ£o de logout no layout (AC: 8)
  - [x] Adicionar botÃ£o Logout em `packages/web/app/(dashboard)/layout.tsx`
  - [x] Chamar POST `/api/auth/logout` e redirecionar

- [x] **Task 6:** Seed do usuÃ¡rio admin (AC: 9)
  - [x] Adicionar criaÃ§Ã£o de usuÃ¡rio admin no `prisma/seed.ts`
  - [x] Hash da senha com bcrypt antes de salvar
  - [x] Usar env vars: `ADMIN_EMAIL`, `ADMIN_PASSWORD` com defaults

## Dev Notes

### DependÃªncias a Instalar

```bash
npm install bcryptjs jose react-hook-form @hookform/resolvers zod
npm install -D @types/bcryptjs
```

### Estrutura do JWT

```typescript
// Payload do token
interface JwtPayload {
  userId: string;
  empresaId: string;
  role: string;
  iat: number;
  exp: number;
}
```

### Helper de AutenticaÃ§Ã£o

Criar `packages/web/lib/auth.ts`:
```typescript
import { jwtVerify, SignJWT } from 'jose';
import { cookies } from 'next/headers';

const JWT_SECRET = new TextEncoder().encode(process.env.NEXTAUTH_SECRET);
const COOKIE_NAME = 'auth-token';

export async function getAuthUser() {
  const cookieStore = cookies();
  const token = cookieStore.get(COOKIE_NAME)?.value;
  if (!token) return null;
  try {
    const { payload } = await jwtVerify(token, JWT_SECRET);
    return payload as JwtPayload;
  } catch {
    return null;
  }
}
```

### SeguranÃ§a

- JWT secret mÃ­nimo 32 caracteres em produÃ§Ã£o
- Cookie httpOnly impede acesso via JavaScript
- ExpiraÃ§Ã£o de 8h balanceia UX e seguranÃ§a para MVP
- Nunca logar senha ou hash de senha

### Rotas Protegidas (middleware matcher)

```typescript
export const config = {
  matcher: ['/((?!login|api/auth|_next|favicon).*)'],
};
```

## ðŸ¤– CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

## File List

- `packages/web/lib/auth.ts` â€” helper JWT (signToken, verifyToken, getAuthUser)
- `packages/web/lib/prisma.ts` â€” singleton Prisma Client com @prisma/adapter-pg
- `packages/web/app/api/auth/login/route.ts` â€” POST login
- `packages/web/app/api/auth/logout/route.ts` â€” POST logout
- `packages/web/middleware.ts` â€” proteÃ§Ã£o de rotas via JWT
- `packages/web/app/(auth)/login/page.tsx` â€” UI de login
- `packages/web/app/(dashboard)/layout.tsx` â€” layout com botÃ£o Sair
- `packages/web/app/page.tsx` â€” redirect para /diagnostico
- `packages/web/prisma/seed.ts` â€” seed admin + perguntas (Prisma v7 adapter)
- `packages/web/prisma/schema.prisma` â€” previewFeatures driverAdapters
- `packages/web/prisma.config.ts` â€” datasource URL
- `packages/web/package.json` â€” tsx para seed, @prisma/adapter-pg, pg

## Dev Agent Record

### Implementation Notes
_A ser preenchido pelo @dev_

### Completion Checklist
- [x] Todos os ACs implementados
- [x] Login funcional com credenciais corretas
- [x] Redirecionamento funcionando (login â†’ dashboard, sem auth â†’ login)
- [x] Logout limpa cookie corretamente
- [x] Senha nunca aparece em logs ou respostas da API
- [x] Status atualizado para Done
