---
id: "1.4"
title: "Diagn√≥stico ‚Äî Question√°rio de Riscos Psicossociais por Setor"
epic: 1
story: 4
status: Done
priority: high
type: fullstack
created: 2026-02-25
updated: 2026-02-25
blockedBy: ["1.3"]
---

# Story 1.4: Diagn√≥stico ‚Äî Question√°rio de Riscos Psicossociais por Setor

## Status: Done

## Story Statement

Como administrador, quero aplicar um question√°rio de riscos psicossociais para cada setor da empresa usando uma escala Likert de 1 a 5, para que o sistema possa identificar e quantificar os riscos por √°rea.

## Acceptance Criteria

- [x] **AC1:** Aba "Question√°rio" do stepper acess√≠vel ap√≥s empresa cadastrada
- [x] **AC2:** Seletor de setor no topo ‚Äî navegar entre setores da empresa
- [x] **AC3:** 15 perguntas exibidas, agrupadas por 5 categorias (3 por categoria): Organiza√ß√£o do Trabalho, Rela√ß√µes Interpessoais, Condi√ß√µes de Trabalho, Viol√™ncia e Ass√©dio, Reconhecimento e Recompensa
- [x] **AC4:** Cada pergunta usa escala Likert visual com 5 op√ß√µes rotuladas: 1=Nunca, 2=Raramente, 3=√Äs vezes, 4=Frequentemente, 5=Sempre
- [x] **AC5:** Respostas salvas automaticamente (auto-save) ao selecionar cada valor ‚Äî sem bot√£o "Salvar" manual
- [x] **AC6:** Indicador de progresso por setor: "X de 15 perguntas respondidas"
- [x] **AC7:** Setor marcado como "completo" quando todas as 15 perguntas forem respondidas
- [x] **AC8:** Bot√£o "Pr√≥ximo Setor" ‚Äî dispon√≠vel ap√≥s completar setor atual; para √∫ltimo setor exibe "Concluir Question√°rio"
- [x] **AC9:** Respostas persistem ao reentrar ‚Äî question√°rio j√° respondido exibe valores salvos
- [x] **AC10:** N√£o √© poss√≠vel prosseguir para Evid√™ncias sem todos os setores com 15/15 respostas

## Tasks / Subtasks

- [x] **Task 1:** Criar API Routes de question√°rio (AC: 5, 9)
  - [x] `GET /api/questionario/perguntas` ‚Äî lista perguntas ativas ordenadas
  - [x] `GET /api/questionario/respostas?setorId=X` ‚Äî respostas do setor
  - [x] `POST /api/questionario/resposta` ‚Äî salva/atualiza resposta individual (upsert)
  - [x] Valida√ß√£o: valor entre 1 e 5, setorId pertence √† empresa do usu√°rio

- [x] **Task 2:** Criar componente de seletor de setor (AC: 2, 7)
  - [x] `SetorSelector` ‚Äî tabs com lista de setores
  - [x] Badge de status: "Completo ‚úì" ou "X/15"
  - [x] Highlight do setor atual

- [x] **Task 3:** Criar componente Likert Scale (AC: 4)
  - [x] `LikertScale` ‚Äî 5 bot√µes radiais estilizados
  - [x] Labels: 1=Nunca, 2=Raramente, 3=√Äs vezes, 4=Frequentemente, 5=Sempre
  - [x] Cor de destaque ao selecionar (escala de verde claro a vermelho)
  - [x] Acessibilidade: role="radiogroup", aria-label

- [x] **Task 4:** Criar componente de grupo de perguntas por categoria (AC: 3)
  - [x] `CategoriaPerguntas` ‚Äî t√≠tulo da categoria + lista de perguntas
  - [x] 5 categorias com √≠cone diferenciado para cada
  - [x] Ordenar por `pergunta.ordem`

- [x] **Task 5:** Implementar auto-save (AC: 5)
  - [x] Ao selecionar valor no Likert, disparar POST imediato
  - [x] Otimistic UI: atualizar contador local sem esperar resposta
  - [x] Indicador visual sutil "Salvando..." / "Salvo"

- [x] **Task 6:** Criar p√°gina do question√°rio (AC: 1, 6, 8, 10)
  - [x] `packages/web/app/(dashboard)/diagnostico/questionario/page.tsx`
  - [x] Barra de progresso global: "Setores completos: X/N"
  - [x] L√≥gica de navega√ß√£o entre setores
  - [x] Validar completude antes de permitir avan√ßar para Evid√™ncias

## Dev Notes

### Perguntas do Seed (15 perguntas, 5 categorias)

```typescript
// prisma/seed.ts ‚Äî perguntas psicossociais baseadas na NR-01 e literatura brasileira
const perguntas = [
  // Organiza√ß√£o do Trabalho
  { categoria: 'organizacao_trabalho', ordem: 1, texto: 'Com que frequ√™ncia voc√™ sente que tem trabalho em excesso para realizar no prazo?' },
  { categoria: 'organizacao_trabalho', ordem: 2, texto: 'Com que frequ√™ncia voc√™ tem autonomia para decidir como realizar suas tarefas?' },
  { categoria: 'organizacao_trabalho', ordem: 3, texto: 'Com que frequ√™ncia as metas estabelecidas s√£o realistas e alcan√ß√°veis?' },
  // Rela√ß√µes Interpessoais
  { categoria: 'relacoes_interpessoais', ordem: 4, texto: 'Com que frequ√™ncia voc√™ recebe apoio de seus colegas quando necessita?' },
  { categoria: 'relacoes_interpessoais', ordem: 5, texto: 'Com que frequ√™ncia h√° conflitos n√£o resolvidos entre membros da equipe?' },
  { categoria: 'relacoes_interpessoais', ordem: 6, texto: 'Com que frequ√™ncia voc√™ se sente respeitado(a) pela sua chefia imediata?' },
  // Condi√ß√µes de Trabalho
  { categoria: 'condicoes_trabalho', ordem: 7, texto: 'Com que frequ√™ncia seu ambiente de trabalho oferece condi√ß√µes adequadas (ilumina√ß√£o, temperatura, ru√≠do)?' },
  { categoria: 'condicoes_trabalho', ordem: 8, texto: 'Com que frequ√™ncia voc√™ disp√µe dos recursos necess√°rios para realizar seu trabalho?' },
  { categoria: 'condicoes_trabalho', ordem: 9, texto: 'Com que frequ√™ncia voc√™ consegue equilibrar vida profissional e pessoal?' },
  // Viol√™ncia e Ass√©dio
  { categoria: 'violencia_assedio', ordem: 10, texto: 'Com que frequ√™ncia voc√™ presencia ou vivencia situa√ß√µes de grosseria ou desrespeito no trabalho?' },
  { categoria: 'violencia_assedio', ordem: 11, texto: 'Com que frequ√™ncia voc√™ se sente pressionado(a) de forma excessiva por superiores?' },
  { categoria: 'violencia_assedio', ordem: 12, texto: 'Com que frequ√™ncia voc√™ observa tratamento diferenciado injusto entre colaboradores?' },
  // Reconhecimento e Recompensa
  { categoria: 'reconhecimento_recompensa', ordem: 13, texto: 'Com que frequ√™ncia seu trabalho √© reconhecido e valorizado pela empresa?' },
  { categoria: 'reconhecimento_recompensa', ordem: 14, texto: 'Com que frequ√™ncia voc√™ recebe feedback construtivo sobre seu desempenho?' },
  { categoria: 'reconhecimento_recompensa', ordem: 15, texto: 'Com que frequ√™ncia voc√™ sente que sua remunera√ß√£o √© justa em rela√ß√£o ao trabalho realizado?' },
];
```

> **Nota:** Perguntas de viol√™ncia/ass√©dio: valor alto (4-5) = situa√ß√£o RUIM.
> Perguntas de apoio/reconhecimento: valor baixo (1-2) = situa√ß√£o RUIM.
> A l√≥gica de invers√£o deve ser aplicada no c√°lculo do risco (Story 1.6).

### Auto-save Pattern

```typescript
// Debounce n√£o necess√°rio ‚Äî radio button, 1 click = 1 valor definitivo
const handleResposta = async (perguntaId: string, valor: number) => {
  setRespostas(prev => ({ ...prev, [perguntaId]: valor }));  // optimistic
  await fetch('/api/questionario/resposta', {
    method: 'POST',
    body: JSON.stringify({ setorId, perguntaId, valor }),
  });
};
```

### Arquivos Principais

- `packages/web/app/(dashboard)/diagnostico/questionario/page.tsx`
- `packages/web/components/questionario/LikertScale.tsx`
- `packages/web/components/questionario/CategoriaPerguntas.tsx`
- `packages/web/components/questionario/SetorSelector.tsx`
- `packages/web/app/api/questionario/resposta/route.ts`

## ü§ñ CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

## File List

- `packages/web/app/api/questionario/perguntas/route.ts` ‚Äî GET lista perguntas ativas
- `packages/web/app/api/questionario/respostas/route.ts` ‚Äî GET respostas por setorId
- `packages/web/app/api/questionario/resposta/route.ts` ‚Äî POST upsert resposta individual
- `packages/web/components/questionario/LikertScale.tsx` ‚Äî escala 1-5 colorida
- `packages/web/components/questionario/SetorSelector.tsx` ‚Äî tabs de setores com badge X/15
- `packages/web/components/questionario/CategoriaPerguntas.tsx` ‚Äî agrupamento por categoria com √≠cone
- `packages/web/app/(dashboard)/diagnostico/questionario/page.tsx` ‚Äî p√°gina principal do question√°rio

## Dev Agent Record

### Implementation Notes
- Auto-save via optimistic UI: estado local atualizado antes do fetch, sem debounce (radio = valor definitivo)
- Setor selector exibe badge `‚úì` quando `totalRespostas >= 15`, ou `X/15` caso contr√°rio
- Navega√ß√£o entre setores reseta `respostas` e recarrega via `carregarRespostas(setorId)`
- Bot√£o "Avan√ßar" desabilitado enquanto setor atual n√£o atingir 15/15
- Para o √∫ltimo setor, bot√£o exibe "Concluir Question√°rio ‚Üí" e redireciona para `/diagnostico/evidencias`

### Completion Checklist
- [x] Todos os ACs implementados
- [x] 15 perguntas em 5 categorias exibidas corretamente
- [x] Auto-save funcionando (sem bot√£o manual)
- [x] Progresso por setor atualizado em tempo real
- [x] Status atualizado para Done
