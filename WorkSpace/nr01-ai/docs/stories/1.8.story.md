---
id: "1.8"
title: "Relat√≥rio Final ‚Äî Gera√ß√£o de PDF"
epic: 1
story: 8
status: Done
priority: high
type: fullstack
created: 2026-02-25
updated: 2026-02-25
blockedBy: ["1.7"]
---

# Story 1.8: Relat√≥rio Final ‚Äî Gera√ß√£o de PDF

## Status: Done

## Story Statement

Como administrador, quero gerar um relat√≥rio final em PDF contendo resumo executivo, matriz de risco, plano de a√ß√£o e lista de evid√™ncias, para que a empresa tenha a documenta√ß√£o formal exigida pela NR-01 com data, respons√°vel e vers√£o do documento.

## Acceptance Criteria

- [x] **AC1:** P√°gina `/relatorio` acess√≠vel com bot√£o "Gerar Relat√≥rio"
- [x] **AC2:** Formul√°rio de metadados antes de gerar: nome do respons√°vel t√©cnico (obrigat√≥rio) e vers√£o do documento (default "1.0")
- [x] **AC3:** PDF gerado com as seguintes se√ß√µes em ordem:
  - Capa: nome da empresa, CNPJ, data de gera√ß√£o, respons√°vel, vers√£o
  - 1. Resumo Executivo (totais: riscos por classifica√ß√£o, a√ß√µes por status)
  - 2. Metodologia (descri√ß√£o do question√°rio e crit√©rios de avalia√ß√£o)
  - 3. Matriz de Risco (visual 3√ó3 com cores, listagem de riscos por setor)
  - 4. Plano de A√ß√£o (tabela 5W2H por risco m√©dio/alto)
  - 5. Evid√™ncias Anexadas (lista: label, tipo, data de upload)
  - Rodap√©: n√∫mero de p√°gina, data, vers√£o, "Gerado pelo Sistema NR-01"
- [x] **AC4:** Preview do PDF renderizado no browser antes de exportar
- [x] **AC5:** Bot√£o "Exportar PDF" faz download do arquivo: `relatorio-nr01-{empresa}-{data}.pdf`
- [x] **AC6:** Relat√≥rio salvo no banco (tabela `relatorios`) com status, respons√°vel e vers√£o
- [x] **AC7:** Bot√£o "Arquivar" marca relat√≥rio como arquivado ‚Äî impede edi√ß√µes posteriores
- [x] **AC8:** Hist√≥rico de relat√≥rios gerados exibido na p√°gina (data, vers√£o, respons√°vel, status)
- [x] **AC9:** PDF em portugu√™s, formata√ß√£o profissional (fonte leg√≠vel, margens adequadas, logo placeholder)

## Tasks / Subtasks

- [x] **Task 1:** Configurar gera√ß√£o de PDF com @react-pdf/renderer (AC: 3, 5, 9)
  - [x] Usar `@react-pdf/renderer` (mais leve que Puppeteer, compat√≠vel com Vercel)
  - [x] Criar `packages/web/lib/pdf/template.tsx` ‚Äî RelatorioDocument React PDF
  - [x] Criar fun√ß√£o `gerarPDF(dados: RelatorioDados): Promise<Buffer>`

- [x] **Task 2:** Criar API Route de gera√ß√£o de PDF (AC: 3, 6)
  - [x] `POST /api/relatorio/gerar` ‚Äî recebe respons√°vel e vers√£o
  - [x] Busca todos os dados: empresa, setores, riscos, planos, evid√™ncias
  - [x] Gera PDF via @react-pdf/renderer
  - [x] Salva PDF no Supabase Storage (bucket `relatorios`)
  - [x] Cria registro em `relatorios` com URL do PDF
  - [x] Retorna URL assinada para download (24h de validade)

- [x] **Task 3:** Template do relat√≥rio com @react-pdf/renderer (AC: 3, 9)
  - [x] Capa com dados da empresa
  - [x] Se√ß√£o 1: Resumo executivo com stat boxes
  - [x] Se√ß√£o 2: Metodologia
  - [x] Se√ß√£o 3: Matriz de risco visual 3√ó3 + lista de riscos
  - [x] Se√ß√£o 4: Tabela 5W2H por risco
  - [x] Se√ß√£o 5: Tabela de evid√™ncias
  - [x] Rodap√© com page number via render prop

- [x] **Task 4:** Preview do PDF no browser via iframe (AC: 4)
  - [x] Exibe URL assinada do Storage em `<iframe>` ap√≥s gera√ß√£o
  - [x] Loading skeleton durante gera√ß√£o

- [x] **Task 5:** Formul√°rio de metadados e hist√≥rico (AC: 2, 8)
  - [x] Form: respons√°vel, vers√£o (react-hook-form + Zod)
  - [x] Componente `RelatorioHistorico` com tabela: data, vers√£o, respons√°vel, status, a√ß√µes

- [x] **Task 6:** P√°gina de Relat√≥rio (AC: 1, 5, 7)
  - [x] `packages/web/app/(dashboard)/relatorio/page.tsx`
  - [x] Bot√£o "Exportar PDF" ‚Üí download via `/api/relatorio/:id/download`
  - [x] Bot√£o "Arquivar" ‚Üí desabilita edi√ß√µes

- [x] **Task 7:** API de listagem e arquivamento (AC: 7, 8)
  - [x] `GET /api/relatorio` ‚Äî lista com URLs assinadas
  - [x] `PUT /api/relatorio/:id/arquivar` ‚Äî status ‚Üí arquivado
  - [x] `GET /api/relatorio/:id/download` ‚Äî proxy download com nome formatado

## Dev Notes

### Depend√™ncias

```bash
npm install puppeteer
# Puppeteer roda apenas server-side (API Route)
```

### Tipo de Dados para Template

```typescript
interface RelatorioDados {
  empresa: { nome: string; cnpj: string; numFunc: number };
  responsavel: string;
  versao: string;
  dataGeracao: string;
  resumo: {
    totalRiscos: number;
    riscosBaixo: number;
    riscosMedio: number;
    riscosAlto: number;
    acoesNaoIniciadas: number;
    acoesEmAndamento: number;
    acoesConcluidas: number;
  };
  riscos: Array<{
    setor: string;
    descricao: string;
    probabilidade: string;
    severidade: string;
    classificacao: string;
    justificativa: string;
    planos: PlanoAcao[];
  }>;
  evidencias: Array<{
    label: string;
    tipo: string;
    criadoEm: string;
  }>;
}
```

### Exemplo de Fun√ß√£o PDF

```typescript
// packages/web/lib/pdf/gerar-pdf.ts
import puppeteer from 'puppeteer';
import { gerarHTML } from './template';

export async function gerarPDF(dados: RelatorioDados): Promise<Buffer> {
  const browser = await puppeteer.launch({ headless: true });
  const page = await browser.newPage();
  await page.setContent(gerarHTML(dados), { waitUntil: 'networkidle0' });
  const pdf = await page.pdf({
    format: 'A4',
    margin: { top: '20mm', bottom: '20mm', left: '20mm', right: '20mm' },
    printBackground: true,
  });
  await browser.close();
  return Buffer.from(pdf);
}
```

### Rodap√© com Numera√ß√£o de P√°gina (CSS)

```css
@page {
  margin: 20mm;
  @bottom-center {
    content: "P√°gina " counter(page) " de " counter(pages);
    font-size: 10px;
    color: #6b7280;
  }
}
```

> **Nota sobre Puppeteer em produ√ß√£o:** Em ambientes serverless (Vercel), usar `@sparticuz/chromium` + `puppeteer-core` em vez de `puppeteer` completo para reduzir bundle size.

### Arquivos Principais

- `packages/web/app/(dashboard)/relatorio/page.tsx`
- `packages/web/lib/pdf/gerar-pdf.ts`
- `packages/web/lib/pdf/template.ts`
- `packages/web/components/relatorio/RelatorioPreview.tsx`
- `packages/web/components/relatorio/RelatorioHistorico.tsx`
- `packages/web/app/api/relatorio/gerar/route.ts`
- `packages/web/app/api/relatorio/route.ts`
- `packages/web/app/api/relatorio/[id]/arquivar/route.ts`

## ü§ñ CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

## File List

- `packages/web/lib/pdf/template.tsx` ‚Äî RelatorioDocument + tipos exportados
- `packages/web/lib/pdf/gerar-pdf.ts` ‚Äî fun√ß√£o gerarPDF com renderToBuffer
- `packages/web/app/api/relatorio/route.ts` ‚Äî GET lista relat√≥rios
- `packages/web/app/api/relatorio/gerar/route.ts` ‚Äî POST gera PDF + salva Storage
- `packages/web/app/api/relatorio/[id]/arquivar/route.ts` ‚Äî PUT arquiva
- `packages/web/app/api/relatorio/[id]/download/route.ts` ‚Äî GET proxy download
- `packages/web/components/relatorio/RelatorioHistorico.tsx` ‚Äî tabela de hist√≥rico
- `packages/web/app/(dashboard)/relatorio/page.tsx` ‚Äî p√°gina principal

## Dev Agent Record

### Implementation Notes
- Substituiu Puppeteer por `@react-pdf/renderer` (mais leve, serverless-compatible)
- Preview via `<iframe src={urlAssinada}>` ‚Äî URL assinada 24h do Supabase Storage
- Download via route `/api/relatorio/:id/download` que faz proxy do Storage com filename formatado
- `gerarPDF` usa cast `as React.ReactElement<DocumentProps>` para compatibilidade com `renderToBuffer`
- Bucket `relatorios` criado automaticamente na primeira gera√ß√£o

### Completion Checklist
- [x] Todos os ACs implementados
- [x] PDF gerado com todas as 5 se√ß√µes
- [x] Download funcionando com nome formatado
- [x] Preview no browser renderizando (iframe com URL assinada)
- [x] Registro salvo no banco
- [x] Status atualizado para Done
