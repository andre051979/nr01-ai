---
id: "1.8"
title: "Relat√≥rio Final ‚Äî Gera√ß√£o de PDF"
epic: 1
story: 8
status: Draft
priority: high
type: fullstack
created: 2026-02-25
updated: 2026-02-25
blockedBy: ["1.7"]
---

# Story 1.8: Relat√≥rio Final ‚Äî Gera√ß√£o de PDF

## Status: Draft

## Story Statement

Como administrador, quero gerar um relat√≥rio final em PDF contendo resumo executivo, matriz de risco, plano de a√ß√£o e lista de evid√™ncias, para que a empresa tenha a documenta√ß√£o formal exigida pela NR-01 com data, respons√°vel e vers√£o do documento.

## Acceptance Criteria

- [ ] **AC1:** P√°gina `/relatorio` acess√≠vel com bot√£o "Gerar Relat√≥rio"
- [ ] **AC2:** Formul√°rio de metadados antes de gerar: nome do respons√°vel t√©cnico (obrigat√≥rio) e vers√£o do documento (default "1.0")
- [ ] **AC3:** PDF gerado com as seguintes se√ß√µes em ordem:
  - Capa: nome da empresa, CNPJ, data de gera√ß√£o, respons√°vel, vers√£o
  - 1. Resumo Executivo (totais: riscos por classifica√ß√£o, a√ß√µes por status)
  - 2. Metodologia (descri√ß√£o do question√°rio e crit√©rios de avalia√ß√£o)
  - 3. Matriz de Risco (visual 3√ó3 com cores, listagem de riscos por setor)
  - 4. Plano de A√ß√£o (tabela 5W2H por risco m√©dio/alto)
  - 5. Evid√™ncias Anexadas (lista: label, tipo, data de upload)
  - Rodap√©: n√∫mero de p√°gina, data, vers√£o, "Gerado pelo Sistema NR-01"
- [ ] **AC4:** Preview do PDF renderizado no browser antes de exportar
- [ ] **AC5:** Bot√£o "Exportar PDF" faz download do arquivo: `relatorio-nr01-{empresa}-{data}.pdf`
- [ ] **AC6:** Relat√≥rio salvo no banco (tabela `relatorios`) com status, respons√°vel e vers√£o
- [ ] **AC7:** Bot√£o "Arquivar" marca relat√≥rio como arquivado ‚Äî impede edi√ß√µes posteriores
- [ ] **AC8:** Hist√≥rico de relat√≥rios gerados exibido na p√°gina (data, vers√£o, respons√°vel, status)
- [ ] **AC9:** PDF em portugu√™s, formata√ß√£o profissional (fonte leg√≠vel, margens adequadas, logo placeholder)

## Tasks / Subtasks

- [ ] **Task 1:** Configurar gera√ß√£o de PDF com Puppeteer (AC: 3, 5, 9)
  - [ ] Instalar `puppeteer` (server-side only)
  - [ ] Criar template HTML do relat√≥rio em `packages/web/lib/pdf/template.ts`
  - [ ] Criar fun√ß√£o `gerarPDF(data: RelatorioDados): Promise<Buffer>`
  - [ ] Configurar Puppeteer: formato A4, margins 20mm, printBackground true

- [ ] **Task 2:** Criar API Route de gera√ß√£o de PDF (AC: 3, 6)
  - [ ] `POST /api/relatorio/gerar` ‚Äî recebe respons√°vel e vers√£o
  - [ ] Busca todos os dados: empresa, setores, riscos, planos, evid√™ncias
  - [ ] Gera PDF via Puppeteer
  - [ ] Salva PDF no Supabase Storage (bucket `relatorios`)
  - [ ] Cria registro em `relatorios` com URL do PDF
  - [ ] Retorna URL assinada para download (24h de validade)

- [ ] **Task 3:** Criar template HTML do relat√≥rio (AC: 3, 9)
  - [ ] Fun√ß√£o que retorna HTML completo com CSS inline (necess√°rio para Puppeteer)
  - [ ] Capa com dados da empresa
  - [ ] Se√ß√£o 1: Resumo executivo com tabelas de contagem
  - [ ] Se√ß√£o 2: Metodologia (texto fixo sobre NR-01 e question√°rio)
  - [ ] Se√ß√£o 3: Matriz de risco visual (HTML/CSS puro) + lista de riscos
  - [ ] Se√ß√£o 4: Tabela 5W2H para cada risco m√©dio/alto
  - [ ] Se√ß√£o 5: Tabela de evid√™ncias
  - [ ] Rodap√© com page number (via CSS @page)
  - [ ] Paleta profissional: cinza escuro para headers, branco para body, cores de risco

- [ ] **Task 4:** Criar preview do PDF no browser (AC: 4)
  - [ ] Componente `RelatorioPreview` usando `<iframe>` com URL blob do PDF
  - [ ] OU: usar `@react-pdf/renderer` para preview client-side
  - [ ] Loading skeleton durante gera√ß√£o
  - [ ] Bot√£o "Regenerar" caso dados tenham sido alterados

- [ ] **Task 5:** Criar formul√°rio de metadados e hist√≥rico (AC: 2, 8)
  - [ ] Form: respons√°vel (input texto), vers√£o (input, default "1.0")
  - [ ] Tabela de hist√≥rico: data, vers√£o, respons√°vel, status, a√ß√£o (baixar / arquivar)
  - [ ] √çcone de status: rascunho (cinza), gerado (verde), arquivado (azul)

- [ ] **Task 6:** Criar p√°gina de Relat√≥rio (AC: 1, 5, 7)
  - [ ] `packages/web/app/(dashboard)/relatorio/page.tsx`
  - [ ] Estado: sem relat√≥rio ‚Üí formul√°rio; com relat√≥rio ‚Üí preview + hist√≥rico
  - [ ] Bot√£o "Exportar PDF" ‚Üí download com nome formatado
  - [ ] Bot√£o "Arquivar" ‚Üí confirma via AlertDialog

- [ ] **Task 7:** Criar API de listagem e arquivamento (AC: 7, 8)
  - [ ] `GET /api/relatorio` ‚Äî lista relat√≥rios da empresa
  - [ ] `PUT /api/relatorio/:id/arquivar` ‚Äî status ‚Üí arquivado

## Dev Notes

### Depend√™ncias

```bash
npm install puppeteer
# Puppeteer roda apenas server-side (API Route)
```

### Tipo de Dados para Template

```typescript
interface RelatorioDados {
  empresa: { nome: string; cnpj: string; numFunc: number };
  responsavel: string;
  versao: string;
  dataGeracao: string;
  resumo: {
    totalRiscos: number;
    riscosBaixo: number;
    riscosMedio: number;
    riscosAlto: number;
    acoesNaoIniciadas: number;
    acoesEmAndamento: number;
    acoesConcluidas: number;
  };
  riscos: Array<{
    setor: string;
    descricao: string;
    probabilidade: string;
    severidade: string;
    classificacao: string;
    justificativa: string;
    planos: PlanoAcao[];
  }>;
  evidencias: Array<{
    label: string;
    tipo: string;
    criadoEm: string;
  }>;
}
```

### Exemplo de Fun√ß√£o PDF

```typescript
// packages/web/lib/pdf/gerar-pdf.ts
import puppeteer from 'puppeteer';
import { gerarHTML } from './template';

export async function gerarPDF(dados: RelatorioDados): Promise<Buffer> {
  const browser = await puppeteer.launch({ headless: true });
  const page = await browser.newPage();
  await page.setContent(gerarHTML(dados), { waitUntil: 'networkidle0' });
  const pdf = await page.pdf({
    format: 'A4',
    margin: { top: '20mm', bottom: '20mm', left: '20mm', right: '20mm' },
    printBackground: true,
  });
  await browser.close();
  return Buffer.from(pdf);
}
```

### Rodap√© com Numera√ß√£o de P√°gina (CSS)

```css
@page {
  margin: 20mm;
  @bottom-center {
    content: "P√°gina " counter(page) " de " counter(pages);
    font-size: 10px;
    color: #6b7280;
  }
}
```

> **Nota sobre Puppeteer em produ√ß√£o:** Em ambientes serverless (Vercel), usar `@sparticuz/chromium` + `puppeteer-core` em vez de `puppeteer` completo para reduzir bundle size.

### Arquivos Principais

- `packages/web/app/(dashboard)/relatorio/page.tsx`
- `packages/web/lib/pdf/gerar-pdf.ts`
- `packages/web/lib/pdf/template.ts`
- `packages/web/components/relatorio/RelatorioPreview.tsx`
- `packages/web/components/relatorio/RelatorioHistorico.tsx`
- `packages/web/app/api/relatorio/gerar/route.ts`
- `packages/web/app/api/relatorio/route.ts`
- `packages/web/app/api/relatorio/[id]/arquivar/route.ts`

## ü§ñ CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

## File List

_A ser preenchido durante implementa√ß√£o_

## Dev Agent Record

### Implementation Notes
_A ser preenchido pelo @dev_

### Completion Checklist
- [ ] Todos os ACs implementados
- [ ] PDF gerado com todas as 5 se√ß√µes
- [ ] Download funcionando com nome formatado
- [ ] Preview no browser renderizando
- [ ] Registro salvo no banco
- [ ] Status atualizado para Done
