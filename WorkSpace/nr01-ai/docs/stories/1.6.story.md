---
id: "1.6"
title: "Avalia√ß√£o ‚Äî Matriz de Risco Autom√°tica"
epic: 1
story: 6
status: Draft
priority: high
type: fullstack
created: 2026-02-25
updated: 2026-02-25
blockedBy: ["1.4"]
---

# Story 1.6: Avalia√ß√£o ‚Äî Matriz de Risco Autom√°tica

## Status: Draft

## Story Statement

Como administrador, quero que o sistema gere automaticamente uma matriz de risco baseada nas respostas do question√°rio, classificando os riscos em baixo, m√©dio ou alto por probabilidade √ó severidade, para que eu possa aprovar a avalia√ß√£o com justificativas t√©cnicas.

## Acceptance Criteria

- [ ] **AC1:** P√°gina `/avaliacao` acess√≠vel ap√≥s conclus√£o do diagn√≥stico
- [ ] **AC2:** Sistema calcula automaticamente probabilidade e severidade por categoria/setor baseado na m√©dia das respostas do question√°rio
- [ ] **AC3:** Matriz de risco visual 3x3 (Probabilidade √ó Severidade) exibida com cores: Verde (baixo), Amarelo (m√©dio), Vermelho (alto)
- [ ] **AC4:** Lista de riscos identificados abaixo da matriz, agrupados por setor
- [ ] **AC5:** Cada risco exibe: descri√ß√£o, setor, probabilidade, severidade, classifica√ß√£o (badge colorido)
- [ ] **AC6:** Campo de justificativa t√©cnica obrigat√≥rio para cada risco antes de aprovar
- [ ] **AC7:** Bot√£o "Aprovar Avalia√ß√£o" ‚Äî dispon√≠vel apenas quando TODOS os riscos t√™m justificativa preenchida (m√≠nimo 20 caracteres)
- [ ] **AC8:** Riscos salvos no banco ao aprovar
- [ ] **AC9:** Possibilidade de editar probabilidade e severidade manualmente (administrador pode ajustar o c√°lculo autom√°tico)
- [ ] **AC10:** Se n√£o h√° riscos m√©dios/altos, exibir mensagem positiva e permitir prosseguir sem plano de a√ß√£o

## Tasks / Subtasks

- [ ] **Task 1:** Criar l√≥gica de c√°lculo de riscos (AC: 2)
  - [ ] Criar `packages/web/lib/calcular-riscos.ts`
  - [ ] Para cada setor + categoria: calcular m√©dia das respostas
  - [ ] Mapear m√©dia para probabilidade:
    - Categorias de frequ√™ncia negativa (sobrecarga, conflitos, etc.): m√©dia ‚â• 4 = Alta, 2.5-3.9 = M√©dia, < 2.5 = Baixa
    - Categorias de frequ√™ncia positiva (autonomia, apoio, etc.): m√©dia ‚â§ 2 = Alta, 2.1-3.5 = M√©dia, > 3.5 = Baixa
  - [ ] Severidade inicial = mesma categoria de probabilidade (base conservadora para MVP)
  - [ ] Calcular classifica√ß√£o: `calcularClassificacao(probabilidade, severidade)`

- [ ] **Task 2:** Criar API de gera√ß√£o/listagem de riscos (AC: 2, 8)
  - [ ] `POST /api/avaliacao/gerar` ‚Äî calcula e persiste riscos automaticamente
  - [ ] `GET /api/avaliacao/riscos` ‚Äî lista riscos da empresa
  - [ ] `PUT /api/avaliacao/risco/:id` ‚Äî atualiza probabilidade, severidade, justificativa
  - [ ] `POST /api/avaliacao/aprovar` ‚Äî marca avalia√ß√£o como aprovada

- [ ] **Task 3:** Criar componente Matriz de Risco Visual (AC: 3)
  - [ ] Grid 3√ó3 com c√©lulas coloridas
  - [ ] Cor: baixo=#22c55e (green-500), m√©dio=#eab308 (yellow-500), alto=#ef4444 (red-500)
  - [ ] Eixo X: Severidade (Baixa, M√©dia, Alta); Eixo Y: Probabilidade (Baixa, M√©dia, Alta)
  - [ ] C√©lulas com contagem de riscos naquela posi√ß√£o
  - [ ] Clique na c√©lula filtra a lista de riscos

- [ ] **Task 4:** Criar componente de card de risco (AC: 4, 5, 6, 9)
  - [ ] `RiscoCard` com: descri√ß√£o, setor, badges de probabilidade/severidade/classifica√ß√£o
  - [ ] Select edit√°vel para probabilidade e severidade (AC: 9)
  - [ ] Textarea para justificativa com contador de caracteres
  - [ ] Visual de valida√ß√£o: borda vermelha se justificativa incompleta

- [ ] **Task 5:** Criar p√°gina de Avalia√ß√£o (AC: 1, 7, 10)
  - [ ] `packages/web/app/(dashboard)/avaliacao/page.tsx`
  - [ ] Bot√£o "Gerar Avalia√ß√£o" ao entrar pela primeira vez
  - [ ] Contador: "X/Y riscos com justificativa"
  - [ ] Bot√£o "Aprovar" habilitado somente quando X=Y
  - [ ] Mensagem especial se 0 riscos m√©dios/altos

- [ ] **Task 6:** Fun√ß√£o de classifica√ß√£o (AC: 2, 3)
  - [ ] Criar fun√ß√£o pura `calcularClassificacao(prob, sev): 'baixo' | 'medio' | 'alto'`
  - [ ] Tabela: Alta√óAlta=alto, Alta√óM√©dia=alto, M√©dia√óAlta=alto, Baixa√óBaixa=baixo, M√©dia√óBaixa=baixo, Baixa√óM√©dia=baixo, todos demais=medio

## Dev Notes

### L√≥gica de C√°lculo de Probabilidade por Categoria

```typescript
// Perguntas onde ALTA resposta = BOM (inverter escala para risco)
const PERGUNTAS_POSITIVAS = [2, 4, 6, 7, 8, 13, 14];
// Perguntas onde ALTA resposta = RUIM (manter escala)
const PERGUNTAS_NEGATIVAS = [1, 3, 5, 9, 10, 11, 12, 15];

function calcularProbabilidade(mediaRespostas: number, isPerguntaPositiva: boolean): 'baixa' | 'media' | 'alta' {
  const score = isPerguntaPositiva ? (6 - mediaRespostas) : mediaRespostas;
  if (score >= 4) return 'alta';
  if (score >= 2.5) return 'media';
  return 'baixa';
}
```

### Tabela de Classifica√ß√£o Final

```typescript
function calcularClassificacao(prob: string, sev: string): string {
  const matrix: Record<string, Record<string, string>> = {
    alta:  { alta: 'alto', media: 'alto', baixa: 'medio' },
    media: { alta: 'alto', media: 'medio', baixa: 'baixo' },
    baixa: { alta: 'medio', media: 'baixo', baixa: 'baixo' },
  };
  return matrix[prob][sev];
}
```

### Riscos Gerados por Setor

Cada setor √ó cada categoria que tiver classifica√ß√£o ‚â• m√©dio gera um risco. Por exemplo:
- "Risco de Sobrecarga de Trabalho" no setor TI ‚Äî Probabilidade: Alta, Severidade: Alta ‚Üí **ALTO**
- "Risco de Relacionamento Interpessoal" no setor Vendas ‚Äî Probabilidade: M√©dia, Severidade: Baixa ‚Üí **BAIXO**

### Arquivos Principais

- `packages/web/app/(dashboard)/avaliacao/page.tsx`
- `packages/web/components/avaliacao/MatrizRisco.tsx`
- `packages/web/components/avaliacao/RiscoCard.tsx`
- `packages/web/lib/calcular-riscos.ts`
- `packages/web/app/api/avaliacao/gerar/route.ts`
- `packages/web/app/api/avaliacao/riscos/route.ts`

## ü§ñ CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

## File List

_A ser preenchido durante implementa√ß√£o_

## Dev Agent Record

### Implementation Notes
_A ser preenchido pelo @dev_

### Completion Checklist
- [ ] Todos os ACs implementados
- [ ] C√°lculo autom√°tico de riscos baseado nas respostas
- [ ] Matriz 3x3 visual com cores corretas
- [ ] Justificativa obrigat√≥ria antes de aprovar
- [ ] Edi√ß√£o manual de probabilidade/severidade funcionando
- [ ] Status atualizado para Done
