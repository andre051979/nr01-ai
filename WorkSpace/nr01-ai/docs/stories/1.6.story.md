---
id: "1.6"
title: "Avalia√ß√£o ‚Äî Matriz de Risco Autom√°tica"
epic: 1
story: 6
status: Done
priority: high
type: fullstack
created: 2026-02-25
updated: 2026-02-25
blockedBy: ["1.4"]
---

# Story 1.6: Avalia√ß√£o ‚Äî Matriz de Risco Autom√°tica

## Status: Done

## Story Statement

Como administrador, quero que o sistema gere automaticamente uma matriz de risco baseada nas respostas do question√°rio, classificando os riscos em baixo, m√©dio ou alto por probabilidade √ó severidade, para que eu possa aprovar a avalia√ß√£o com justificativas t√©cnicas.

## Acceptance Criteria

- [x] **AC1:** P√°gina `/avaliacao` acess√≠vel ap√≥s conclus√£o do diagn√≥stico
- [x] **AC2:** Sistema calcula automaticamente probabilidade e severidade por categoria/setor baseado na m√©dia das respostas do question√°rio
- [x] **AC3:** Matriz de risco visual 3x3 (Probabilidade √ó Severidade) exibida com cores: Verde (baixo), Amarelo (m√©dio), Vermelho (alto)
- [x] **AC4:** Lista de riscos identificados abaixo da matriz, agrupados por setor
- [x] **AC5:** Cada risco exibe: descri√ß√£o, setor, probabilidade, severidade, classifica√ß√£o (badge colorido)
- [x] **AC6:** Campo de justificativa t√©cnica obrigat√≥rio para cada risco antes de aprovar
- [x] **AC7:** Bot√£o "Aprovar Avalia√ß√£o" ‚Äî dispon√≠vel apenas quando TODOS os riscos t√™m justificativa preenchida (m√≠nimo 20 caracteres)
- [x] **AC8:** Riscos salvos no banco ao aprovar
- [x] **AC9:** Possibilidade de editar probabilidade e severidade manualmente
- [x] **AC10:** Se n√£o h√° riscos m√©dios/altos, exibir mensagem positiva e permitir prosseguir sem plano de a√ß√£o

## Tasks / Subtasks

- [x] **Task 1:** Criar l√≥gica de c√°lculo de riscos (AC: 2)
  - [x] `lib/calcular-riscos.ts` com score invertido para perguntas positivas
  - [x] `calcularRiscosSetor()` retorna resultado por categoria
  - [x] `scoreParaNivel()` mapeia m√©dia para baixa/media/alta

- [x] **Task 2:** Criar API de gera√ß√£o/listagem de riscos (AC: 2, 8)
  - [x] `POST /api/avaliacao/gerar` ‚Äî calcula e persiste (apenas medio/alto)
  - [x] `GET /api/avaliacao/riscos` ‚Äî lista riscos da empresa
  - [x] `PUT /api/avaliacao/risco/[id]` ‚Äî atualiza prob, sev, just (recalcula classificacao)
  - [x] `POST /api/avaliacao/aprovar` ‚Äî valida justificativas >= 20 chars

- [x] **Task 3:** Criar componente Matriz de Risco Visual (AC: 3)
  - [x] Grid 3√ó3 colorido (verde/amarelo/vermelho)
  - [x] Contador de riscos por c√©lula
  - [x] Clique na c√©lula filtra lista

- [x] **Task 4:** Criar componente de card de risco (AC: 4, 5, 6, 9)
  - [x] `RiscoCard` com select edit√°vel para prob/sev
  - [x] Badge de classifica√ß√£o recalculado client-side
  - [x] Textarea para justificativa com contador de chars
  - [x] Auto-save on blur (justificativa) e on change (prob/sev)

- [x] **Task 5:** Criar p√°gina de Avalia√ß√£o (AC: 1, 7, 10)
  - [x] `app/(dashboard)/avaliacao/page.tsx`
  - [x] Estado: n√£o gerado ‚Üí "Gerar", gerado com 0 ‚Üí AC10 message, gerado com N ‚Üí lista
  - [x] Contador X/Y com justificativas
  - [x] Bot√£o Aprovar habilitado apenas quando X=Y

- [x] **Task 6:** Fun√ß√£o de classifica√ß√£o (AC: 2, 3)
  - [x] `calcularClassificacao(prob, sev)` com tabela completa 3√ó3

## Dev Notes

### L√≥gica implementada

- Perguntas positivas (alta = bom): ordens [2, 4, 6, 7, 8, 13, 14] ‚Üí score = 6 - valor
- Perguntas negativas (alta = ruim): ordens [1, 3, 5, 9, 10, 11, 12, 15] ‚Üí score = valor
- M√©dia dos scores da categoria ‚Üí nivel: ‚â•4=alta, ‚â•2.5=m√©dia, <2.5=baixa
- Severidade = Probabilidade (conservador para MVP)
- Apenas riscos medio/alto s√£o persisted

### Arquivos Principais

- `packages/web/lib/calcular-riscos.ts` ‚Äî l√≥gica pura de c√°lculo
- `packages/web/app/api/avaliacao/gerar/route.ts` ‚Äî POST
- `packages/web/app/api/avaliacao/riscos/route.ts` ‚Äî GET
- `packages/web/app/api/avaliacao/risco/[id]/route.ts` ‚Äî PUT
- `packages/web/app/api/avaliacao/aprovar/route.ts` ‚Äî POST
- `packages/web/components/avaliacao/MatrizRisco.tsx`
- `packages/web/components/avaliacao/RiscoCard.tsx`
- `packages/web/app/(dashboard)/avaliacao/page.tsx`

## ü§ñ CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

## File List

- `packages/web/lib/calcular-riscos.ts`
- `packages/web/app/api/avaliacao/gerar/route.ts`
- `packages/web/app/api/avaliacao/riscos/route.ts`
- `packages/web/app/api/avaliacao/risco/[id]/route.ts`
- `packages/web/app/api/avaliacao/aprovar/route.ts`
- `packages/web/components/avaliacao/MatrizRisco.tsx`
- `packages/web/components/avaliacao/RiscoCard.tsx`
- `packages/web/app/(dashboard)/avaliacao/page.tsx`

## Dev Agent Record

### Implementation Notes
- `gerar` deleta riscos existentes e recria (idempotente)
- Classifica√ß√£o matriz: Alta√óAlta=alto, Alta√óM√©dia=alto, M√©dia√óAlta=alto, Baixa√óBaixa=baixo, etc.
- MatrizRisco: clique em c√©lula filtra lista; segundo clique remove filtro
- RiscoCard: prob/sev salva imediatamente ao mudar select; justificativa salva on blur
- Classifica√ß√£o no card √© recalculada client-side ap√≥s mudar prob/sev para feedback imediato

### Completion Checklist
- [x] Todos os ACs implementados
- [x] C√°lculo autom√°tico de riscos baseado nas respostas
- [x] Matriz 3x3 visual com cores corretas
- [x] Justificativa obrigat√≥ria antes de aprovar
- [x] Edi√ß√£o manual de probabilidade/severidade funcionando
- [x] Status atualizado para Done
