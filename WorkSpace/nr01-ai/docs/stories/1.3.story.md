---
id: "1.3"
title: "Diagn√≥stico ‚Äî Cadastro da Empresa e Setores"
epic: 1
story: 3
status: Draft
priority: high
type: fullstack
created: 2026-02-25
updated: 2026-02-25
blockedBy: ["1.2"]
---

# Story 1.3: Diagn√≥stico ‚Äî Cadastro da Empresa e Setores

## Status: Done

## Story Statement

Como administrador, quero cadastrar os dados da empresa (nome, CNPJ, n√∫mero de funcion√°rios) e seus setores, para que eu possa iniciar o diagn√≥stico de riscos psicossociais de forma organizada por √°rea.

## Acceptance Criteria

- [ ] **AC1:** P√°gina `/diagnostico` com stepper visual mostrando as 3 abas: "Empresa", "Question√°rio", "Evid√™ncias"
- [ ] **AC2:** Formul√°rio de cadastro da empresa com campos: Nome (obrigat√≥rio), CNPJ (obrigat√≥rio, m√°scara XX.XXX.XXX/XXXX-XX, validado), N√∫mero de funcion√°rios (obrigat√≥rio, inteiro positivo)
- [ ] **AC3:** CNPJ validado com algoritmo oficial (d√≠gitos verificadores) ‚Äî exibir erro "CNPJ inv√°lido" em tempo real
- [ ] **AC4:** Se√ß√£o de setores: adicionar setores dinamicamente com nome e n√∫mero de funcion√°rios opcional
- [ ] **AC5:** M√≠nimo de 1 setor obrigat√≥rio para prosseguir
- [ ] **AC6:** Bot√£o para remover setor individual (m√≠nimo 1 setor sempre mantido)
- [ ] **AC7:** Dados salvos no banco ao clicar em "Salvar e Continuar" ‚Äî empresa + setores persistidos
- [ ] **AC8:** Se empresa j√° cadastrada (re-entrada), carregar dados existentes para edi√ß√£o
- [ ] **AC9:** Valida√ß√£o inline em todos os campos obrigat√≥rios

## Tasks / Subtasks

- [x] **Task 1:** Criar API Routes de empresa (AC: 7, 8)
  - [x] `GET /api/empresa` ‚Äî busca empresa do usu√°rio logado (via JWT)
  - [x] `POST /api/empresa` ‚Äî cria empresa + setores em transa√ß√£o
  - [x] `PUT /api/empresa` ‚Äî atualiza empresa + setores
  - [x] Valida√ß√£o com Zod em todas as rotas
  - [x] Usar `prisma.$transaction()` para atomicidade

- [x] **Task 2:** Criar componente de m√°scara de CNPJ (AC: 2, 3)
  - [x] Implementado manualmente em `lib/cnpj.ts`
  - [x] Fun√ß√£o `validarCNPJ(cnpj: string): boolean` com algoritmo oficial
  - [x] Integrado via `setValue` no react-hook-form

- [x] **Task 3:** Criar componente de lista din√¢mica de setores (AC: 4, 5, 6)
  - [x] Componente `SetorList` com `useFieldArray` do react-hook-form
  - [x] Bot√£o "Adicionar Setor" ‚Äî adiciona novo item √† lista
  - [x] Bot√£o remover por setor (desabilitado quando s√≥ 1 setor)
  - [x] Campos: nome do setor (obrigat√≥rio), n√∫mero de funcion√°rios (opcional)

- [x] **Task 4:** Criar p√°gina `/diagnostico` com stepper (AC: 1)
  - [x] Componente `DiagnosticoStepper` com 3 etapas
  - [x] Aba ativa: "Empresa" (step 1)
  - [x] Steps 2 e 3 desabilitados at√© empresa salva

- [x] **Task 5:** Criar formul√°rio de empresa completo (AC: 2, 3, 9)
  - [x] Form com react-hook-form + Zod schema em `EmpresaForm.tsx`
  - [x] Feedback visual de sucesso ao salvar
  - [x] Loading state durante submit

- [x] **Task 6:** Implementar carregamento de dados existentes (AC: 8)
  - [x] `useEffect` ao montar o componente: buscar empresa via GET
  - [x] Pr√©-preencher form com dados existentes
  - [x] Indicar visualmente que est√° em modo edi√ß√£o

## Dev Notes

### Zod Schema da Empresa

```typescript
import { z } from 'zod';

const setorSchema = z.object({
  id: z.string().uuid().optional(),
  nome: z.string().min(2, 'Nome muito curto').max(100),
  numFunc: z.number().int().positive().optional(),
});

const empresaSchema = z.object({
  nome: z.string().min(2).max(255),
  cnpj: z.string().length(14, 'CNPJ deve ter 14 d√≠gitos').refine(validarCNPJ, 'CNPJ inv√°lido'),
  numFunc: z.number().int().positive('Deve ser positivo'),
  setores: z.array(setorSchema).min(1, 'Adicione pelo menos 1 setor'),
});
```

### Algoritmo de Valida√ß√£o de CNPJ

```typescript
export function validarCNPJ(cnpj: string): boolean {
  const nums = cnpj.replace(/\D/g, '');
  if (nums.length !== 14) return false;
  if (/^(\d)\1+$/.test(nums)) return false;

  const calc = (n: string, len: number) => {
    let sum = 0, pos = len - 7;
    for (let i = len; i >= 1; i--) {
      sum += parseInt(n[len - i]) * pos--;
      if (pos < 2) pos = 9;
    }
    const result = sum % 11 < 2 ? 0 : 11 - (sum % 11);
    return result === parseInt(n[len]);
  };

  return calc(nums, 12) && calc(nums, 13);
}
```

### Arquivo de Localiza√ß√£o

- P√°gina: `packages/web/app/(dashboard)/diagnostico/page.tsx`
- Componente stepper: `packages/web/components/diagnostico/DiagnosticoStepper.tsx`
- Componente setores: `packages/web/components/diagnostico/SetorList.tsx`
- API: `packages/web/app/api/empresa/route.ts`

### Transa√ß√£o Prisma (criar empresa + setores)

```typescript
const result = await prisma.$transaction(async (tx) => {
  const empresa = await tx.empresa.create({ data: { nome, cnpj, numFunc } });
  const setores = await tx.setor.createMany({
    data: setoresData.map(s => ({ ...s, empresaId: empresa.id }))
  });
  return { empresa, setores };
});
```

## ü§ñ CodeRabbit Integration

> **CodeRabbit Integration**: Disabled

## File List

- `packages/web/lib/cnpj.ts` ‚Äî validarCNPJ + formatarCNPJ
- `packages/web/app/api/empresa/route.ts` ‚Äî GET / POST / PUT com $transaction
- `packages/web/components/diagnostico/SetorList.tsx` ‚Äî lista din√¢mica com useFieldArray
- `packages/web/components/diagnostico/DiagnosticoStepper.tsx` ‚Äî stepper 3 etapas
- `packages/web/components/diagnostico/EmpresaForm.tsx` ‚Äî formul√°rio completo
- `packages/web/app/(dashboard)/diagnostico/page.tsx` ‚Äî p√°gina /diagnostico

## Dev Agent Record

### Implementation Notes
_A ser preenchido pelo @dev_

### Completion Checklist
- [x] Todos os ACs implementados
- [x] CNPJ validado com algoritmos de d√≠gitos verificadores
- [x] Transa√ß√£o at√¥mica empresa + setores
- [x] Stepper naveg√°vel funcionando
- [x] Status atualizado para Done
